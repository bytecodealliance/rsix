# Test a selection of projects which depend on rustix.

name: Test rustix's users

on: workflow_dispatch

jobs:
  async-io:
    name: async-io ported to rustix
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        build: [ubuntu, i686-linux, aarch64-linux, riscv64-linux, arm-linux, macos-11]
        include:
          - build: ubuntu
            os: ubuntu-latest
            rust: nightly
          - build: i686-linux
            os: ubuntu-latest
            rust: nightly
            target: i686-unknown-linux-gnu
            gcc_package: gcc-i686-linux-gnu
            gcc: i686-linux-gnu-gcc
            libc_package: libc-dev-i386-cross
          - build: aarch64-linux
            os: ubuntu-latest
            rust: nightly
            target: aarch64-unknown-linux-gnu
            gcc_package: gcc-aarch64-linux-gnu
            gcc: aarch64-linux-gnu-gcc
            qemu: qemu-aarch64 -L /usr/aarch64-linux-gnu
            qemu_target: aarch64-linux-user
          - build: riscv64-linux
            os: ubuntu-latest
            rust: nightly
            target: riscv64gc-unknown-linux-gnu
            gcc_package: gcc-riscv64-linux-gnu
            gcc: riscv64-linux-gnu-gcc
            qemu: qemu-riscv64 -L /usr/riscv64-linux-gnu
            qemu_target: riscv64-linux-user
          - build: arm-linux
            os: ubuntu-latest
            rust: nightly
            target: armv5te-unknown-linux-gnueabi
            gcc_package: gcc-arm-linux-gnueabi
            gcc: arm-linux-gnueabi-gcc
            qemu: qemu-arm -L /usr/arm-linux-gnueabi
            qemu_target: arm-linux-user
          - build: macos-11
            os: macos-11
            rust: nightly
    steps:
    - uses: actions/checkout@v2
      with:
        submodules: true
    - uses: ./.github/actions/install-rust
      with:
        toolchain: ${{ matrix.rust }}
    - uses: actions/checkout@v2
      with:
        repository: sunfishcode/async-io
        path: async-io
    - uses: ./.github/workflows/cross.yml
      with:
        os: ${{ matrix.os }
        target: ${{ matrix.target }}
        libc_package: ${{ matrix.libc_package }}
        gcc_package: ${{ matrix.gcc_package }}
        gcc: ${{ matrix.gcc }}
        qemu: ${{ matrix.qemu }}
        qemu_target: ${{ matrix.qemu_target }}
    - run: cd async-io && echo '[patch.crates-io]' >> Cargo.toml
    - run: cd async-io && echo 'rustix = { path = ".." }' >> Cargo.toml
    - run: cd async-io && cargo test

  cap-std:
    name: cap-std
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        build: [ubuntu, i686-linux, aarch64-linux, riscv64-linux, arm-linux, macos-11]
        include:
          - build: ubuntu
            os: ubuntu-latest
            rust: nightly
          - build: i686-linux
            os: ubuntu-latest
            rust: nightly
            target: i686-unknown-linux-gnu
            gcc_package: gcc-i686-linux-gnu
            gcc: i686-linux-gnu-gcc
            libc_package: libc-dev-i386-cross
          - build: aarch64-linux
            os: ubuntu-latest
            rust: nightly
            target: aarch64-unknown-linux-gnu
            gcc_package: gcc-aarch64-linux-gnu
            gcc: aarch64-linux-gnu-gcc
            qemu: qemu-aarch64 -L /usr/aarch64-linux-gnu
            qemu_target: aarch64-linux-user
          - build: riscv64-linux
            os: ubuntu-latest
            rust: nightly
            target: riscv64gc-unknown-linux-gnu
            gcc_package: gcc-riscv64-linux-gnu
            gcc: riscv64-linux-gnu-gcc
            qemu: qemu-riscv64 -L /usr/riscv64-linux-gnu
            qemu_target: riscv64-linux-user
          - build: arm-linux
            os: ubuntu-latest
            rust: nightly
            target: armv5te-unknown-linux-gnueabi
            gcc_package: gcc-arm-linux-gnueabi
            gcc: arm-linux-gnueabi-gcc
            qemu: qemu-arm -L /usr/arm-linux-gnueabi
            qemu_target: arm-linux-user
          - build: macos-11
            os: macos-11
            rust: nightly
    steps:
    - uses: actions/checkout@v2
      with:
        submodules: true
    - uses: ./.github/actions/install-rust
      with:
        toolchain: ${{ matrix.rust }}
    - uses: actions/checkout@v2
      with:
        repository: bytecodealliance/cap-std
        path: cap-std
    - uses: ./.github/workflows/cross.yml
      with:
        os: ${{ matrix.os }
        target: ${{ matrix.target }}
        libc_package: ${{ matrix.libc_package }}
        gcc_package: ${{ matrix.gcc_package }}
        gcc: ${{ matrix.gcc }}
        qemu: ${{ matrix.qemu }}
        qemu_target: ${{ matrix.qemu_target }}
    - run: cd cap-std && echo '[patch.crates-io]' >> Cargo.toml
    - run: cd cap-std && echo 'rustix = { path = ".." }' >> Cargo.toml
    - run: cd cap-std && cargo test

  cargo:
    name: cargo ported to rustix
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        build: [ubuntu, i686-linux, aarch64-linux, riscv64-linux, arm-linux, macos-11]
        include:
          - build: ubuntu
            os: ubuntu-latest
            rust: nightly
          - build: i686-linux
            os: ubuntu-latest
            rust: nightly
            target: i686-unknown-linux-gnu
            gcc_package: gcc-i686-linux-gnu
            gcc: i686-linux-gnu-gcc
            libc_package: libc-dev-i386-cross
          - build: aarch64-linux
            os: ubuntu-latest
            rust: nightly
            target: aarch64-unknown-linux-gnu
            gcc_package: gcc-aarch64-linux-gnu
            gcc: aarch64-linux-gnu-gcc
            qemu: qemu-aarch64 -L /usr/aarch64-linux-gnu
            qemu_target: aarch64-linux-user
          - build: riscv64-linux
            os: ubuntu-latest
            rust: nightly
            target: riscv64gc-unknown-linux-gnu
            gcc_package: gcc-riscv64-linux-gnu
            gcc: riscv64-linux-gnu-gcc
            qemu: qemu-riscv64 -L /usr/riscv64-linux-gnu
            qemu_target: riscv64-linux-user
          - build: arm-linux
            os: ubuntu-latest
            rust: nightly
            target: armv5te-unknown-linux-gnueabi
            gcc_package: gcc-arm-linux-gnueabi
            gcc: arm-linux-gnueabi-gcc
            qemu: qemu-arm -L /usr/arm-linux-gnueabi
            qemu_target: arm-linux-user
          - build: macos-11
            os: macos-11
            rust: nightly
    steps:
    - uses: actions/checkout@v2
      with:
        submodules: true
    - uses: ./.github/actions/install-rust
      with:
        toolchain: ${{ matrix.rust }}
    - uses: actions/checkout@v2
      with:
        repository: sunfishcode/cargo
        path: cargo
        ref: rustix
    - uses: ./.github/workflows/cross.yml
      with:
        os: ${{ matrix.os }
        target: ${{ matrix.target }}
        libc_package: ${{ matrix.libc_package }}
        gcc_package: ${{ matrix.gcc_package }}
        gcc: ${{ matrix.gcc }}
        qemu: ${{ matrix.qemu }}
        qemu_target: ${{ matrix.qemu_target }}
    - run: cd cargo && echo '[patch.crates-io]' >> Cargo.toml
    - run: cd cargo && echo 'rustix = { path = ".." }' >> Cargo.toml
    - run: cd cargo && cargo test --workspace
      # Cargo cross tests require extra build dependencies.
      env:
        CFG_DISABLE_CROSS_TESTS: 1

  memfd-rs:
    name: memfd-rs ported to rustix
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        build: [ubuntu, i686-linux, aarch64-linux, riscv64-linux, arm-linux, macos-11]
        include:
          - build: ubuntu
            os: ubuntu-latest
            rust: nightly
          - build: i686-linux
            os: ubuntu-latest
            rust: nightly
            target: i686-unknown-linux-gnu
            gcc_package: gcc-i686-linux-gnu
            gcc: i686-linux-gnu-gcc
            libc_package: libc-dev-i386-cross
          - build: aarch64-linux
            os: ubuntu-latest
            rust: nightly
            target: aarch64-unknown-linux-gnu
            gcc_package: gcc-aarch64-linux-gnu
            gcc: aarch64-linux-gnu-gcc
            qemu: qemu-aarch64 -L /usr/aarch64-linux-gnu
            qemu_target: aarch64-linux-user
          - build: riscv64-linux
            os: ubuntu-latest
            rust: nightly
            target: riscv64gc-unknown-linux-gnu
            gcc_package: gcc-riscv64-linux-gnu
            gcc: riscv64-linux-gnu-gcc
            qemu: qemu-riscv64 -L /usr/riscv64-linux-gnu
            qemu_target: riscv64-linux-user
          - build: arm-linux
            os: ubuntu-latest
            rust: nightly
            target: armv5te-unknown-linux-gnueabi
            gcc_package: gcc-arm-linux-gnueabi
            gcc: arm-linux-gnueabi-gcc
            qemu: qemu-arm -L /usr/arm-linux-gnueabi
            qemu_target: arm-linux-user
          - build: macos-11
            os: macos-11
            rust: nightly
    steps:
    - uses: actions/checkout@v2
      with:
        submodules: true
    - uses: ./.github/actions/install-rust
      with:
        toolchain: ${{ matrix.rust }}
    - uses: actions/checkout@v2
      with:
        repository: sunfishcode/memfd-rs
        path: memfd-rs
    - uses: ./.github/workflows/cross.yml
      with:
        os: ${{ matrix.os }
        target: ${{ matrix.target }}
        libc_package: ${{ matrix.libc_package }}
        gcc_package: ${{ matrix.gcc_package }}
        gcc: ${{ matrix.gcc }}
        qemu: ${{ matrix.qemu }}
        qemu_target: ${{ matrix.qemu_target }}
    - run: cd memfd-rs && echo '[patch.crates-io]' >> Cargo.toml
    - run: cd memfd-rs && echo 'rustix = { path = ".." }' >> Cargo.toml
    - run: cd memfd-rs && cargo test

  tempfile:
    name: tempfile ported to rustix
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        build: [ubuntu, i686-linux, aarch64-linux, riscv64-linux, arm-linux, macos-11]
        include:
          - build: ubuntu
            os: ubuntu-latest
            rust: nightly
          - build: i686-linux
            os: ubuntu-latest
            rust: nightly
            target: i686-unknown-linux-gnu
            gcc_package: gcc-i686-linux-gnu
            gcc: i686-linux-gnu-gcc
            libc_package: libc-dev-i386-cross
          - build: aarch64-linux
            os: ubuntu-latest
            rust: nightly
            target: aarch64-unknown-linux-gnu
            gcc_package: gcc-aarch64-linux-gnu
            gcc: aarch64-linux-gnu-gcc
            qemu: qemu-aarch64 -L /usr/aarch64-linux-gnu
            qemu_target: aarch64-linux-user
          - build: riscv64-linux
            os: ubuntu-latest
            rust: nightly
            target: riscv64gc-unknown-linux-gnu
            gcc_package: gcc-riscv64-linux-gnu
            gcc: riscv64-linux-gnu-gcc
            qemu: qemu-riscv64 -L /usr/riscv64-linux-gnu
            qemu_target: riscv64-linux-user
          - build: arm-linux
            os: ubuntu-latest
            rust: nightly
            target: armv5te-unknown-linux-gnueabi
            gcc_package: gcc-arm-linux-gnueabi
            gcc: arm-linux-gnueabi-gcc
            qemu: qemu-arm -L /usr/arm-linux-gnueabi
            qemu_target: arm-linux-user
          - build: macos-11
            os: macos-11
            rust: nightly
    steps:
    - uses: actions/checkout@v2
      with:
        submodules: true
    - uses: ./.github/actions/install-rust
      with:
        toolchain: ${{ matrix.rust }}
    - uses: actions/checkout@v2
      with:
        repository: sunfishcode/tempfile
        path: tempfile
    - uses: ./.github/workflows/cross.yml
      with:
        os: ${{ matrix.os }
        target: ${{ matrix.target }}
        libc_package: ${{ matrix.libc_package }}
        gcc_package: ${{ matrix.gcc_package }}
        gcc: ${{ matrix.gcc }}
        qemu: ${{ matrix.qemu }}
        qemu_target: ${{ matrix.qemu_target }}
    - run: cd tempfile && echo '[patch.crates-io]' >> Cargo.toml
    - run: cd tempfile && echo 'rustix = { path = ".." }' >> Cargo.toml
    - run: cd tempfile && cargo test

  fd-lock:
    name: fd-lock
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        build: [ubuntu, i686-linux, aarch64-linux, riscv64-linux, arm-linux, macos-11]
        include:
          - build: ubuntu
            os: ubuntu-latest
            rust: nightly
          - build: i686-linux
            os: ubuntu-latest
            rust: nightly
            target: i686-unknown-linux-gnu
            gcc_package: gcc-i686-linux-gnu
            gcc: i686-linux-gnu-gcc
            libc_package: libc-dev-i386-cross
          - build: aarch64-linux
            os: ubuntu-latest
            rust: nightly
            target: aarch64-unknown-linux-gnu
            gcc_package: gcc-aarch64-linux-gnu
            gcc: aarch64-linux-gnu-gcc
            qemu: qemu-aarch64 -L /usr/aarch64-linux-gnu
            qemu_target: aarch64-linux-user
          - build: riscv64-linux
            os: ubuntu-latest
            rust: nightly
            target: riscv64gc-unknown-linux-gnu
            gcc_package: gcc-riscv64-linux-gnu
            gcc: riscv64-linux-gnu-gcc
            qemu: qemu-riscv64 -L /usr/riscv64-linux-gnu
            qemu_target: riscv64-linux-user
          - build: arm-linux
            os: ubuntu-latest
            rust: nightly
            target: armv5te-unknown-linux-gnueabi
            gcc_package: gcc-arm-linux-gnueabi
            gcc: arm-linux-gnueabi-gcc
            qemu: qemu-arm -L /usr/arm-linux-gnueabi
            qemu_target: arm-linux-user
          - build: macos-11
            os: macos-11
            rust: nightly
    steps:
    - uses: actions/checkout@v2
      with:
        submodules: true
    - uses: ./.github/actions/install-rust
      with:
        toolchain: ${{ matrix.rust }}
    - uses: actions/checkout@v2
      with:
        repository: yoshuawuyts/fd-lock
        path: fd-lock
    - uses: ./.github/workflows/cross.yml
      with:
        os: ${{ matrix.os }
        target: ${{ matrix.target }}
        libc_package: ${{ matrix.libc_package }}
        gcc_package: ${{ matrix.gcc_package }}
        gcc: ${{ matrix.gcc }}
        qemu: ${{ matrix.qemu }}
        qemu_target: ${{ matrix.qemu_target }}
    # fd-lock currently uses rustix 0.32.
    - run: sed -i 's/^version = "\([[:digit:].-]*\)"$/version = "0.32.0"/' Cargo.toml
    - run: cd fd-lock && echo '[patch.crates-io]' >> Cargo.toml
    - run: cd fd-lock && echo 'rustix = { path = ".." }' >> Cargo.toml
    - run: cd fd-lock && cargo test

  wasmtime:
    name: wasmtime
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        build: [ubuntu, i686-linux, aarch64-linux, riscv64-linux, arm-linux, macos-11]
        include:
          - build: ubuntu
            os: ubuntu-latest
            rust: nightly
          - build: i686-linux
            os: ubuntu-latest
            rust: nightly
            target: i686-unknown-linux-gnu
            gcc_package: gcc-i686-linux-gnu
            gcc: i686-linux-gnu-gcc
            libc_package: libc-dev-i386-cross
          - build: aarch64-linux
            os: ubuntu-latest
            rust: nightly
            target: aarch64-unknown-linux-gnu
            gcc_package: gcc-aarch64-linux-gnu
            gcc: aarch64-linux-gnu-gcc
            qemu: qemu-aarch64 -L /usr/aarch64-linux-gnu
            qemu_target: aarch64-linux-user
          - build: riscv64-linux
            os: ubuntu-latest
            rust: nightly
            target: riscv64gc-unknown-linux-gnu
            gcc_package: gcc-riscv64-linux-gnu
            gcc: riscv64-linux-gnu-gcc
            qemu: qemu-riscv64 -L /usr/riscv64-linux-gnu
            qemu_target: riscv64-linux-user
          - build: arm-linux
            os: ubuntu-latest
            rust: nightly
            target: armv5te-unknown-linux-gnueabi
            gcc_package: gcc-arm-linux-gnueabi
            gcc: arm-linux-gnueabi-gcc
            qemu: qemu-arm -L /usr/arm-linux-gnueabi
            qemu_target: arm-linux-user
          - build: macos-11
            os: macos-11
            rust: nightly
    steps:
    - uses: actions/checkout@v2
      with:
        submodules: true
    - uses: ./.github/actions/install-rust
      with:
        toolchain: ${{ matrix.rust }}
    - uses: actions/checkout@v2
      with:
        repository: bytecodealliance/wasmtime
        path: wasmtime
        submodules: true
    - uses: ./.github/workflows/cross.yml
      with:
        os: ${{ matrix.os }
        target: ${{ matrix.target }}
        libc_package: ${{ matrix.libc_package }}
        gcc_package: ${{ matrix.gcc_package }}
        gcc: ${{ matrix.gcc }}
        qemu: ${{ matrix.qemu }}
        qemu_target: ${{ matrix.qemu_target }}
    - run: rustup target add wasm32-wasi
    - run: cd wasmtime && echo '[patch.crates-io]' >> Cargo.toml
    - run: cd wasmtime && echo 'rustix = { path = ".." }' >> Cargo.toml
    - run: cd wasmtime && cargo test

  nameless:
    name: nameless
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        build: [ubuntu, i686-linux, aarch64-linux, riscv64-linux, arm-linux, macos-11]
        include:
          - build: ubuntu
            os: ubuntu-latest
            rust: nightly
          - build: i686-linux
            os: ubuntu-latest
            rust: nightly
            target: i686-unknown-linux-gnu
            gcc_package: gcc-i686-linux-gnu
            gcc: i686-linux-gnu-gcc
            libc_package: libc-dev-i386-cross
          - build: aarch64-linux
            os: ubuntu-latest
            rust: nightly
            target: aarch64-unknown-linux-gnu
            gcc_package: gcc-aarch64-linux-gnu
            gcc: aarch64-linux-gnu-gcc
            qemu: qemu-aarch64 -L /usr/aarch64-linux-gnu
            qemu_target: aarch64-linux-user
          - build: riscv64-linux
            os: ubuntu-latest
            rust: nightly
            target: riscv64gc-unknown-linux-gnu
            gcc_package: gcc-riscv64-linux-gnu
            gcc: riscv64-linux-gnu-gcc
            qemu: qemu-riscv64 -L /usr/riscv64-linux-gnu
            qemu_target: riscv64-linux-user
          - build: arm-linux
            os: ubuntu-latest
            rust: nightly
            target: armv5te-unknown-linux-gnueabi
            gcc_package: gcc-arm-linux-gnueabi
            gcc: arm-linux-gnueabi-gcc
            qemu: qemu-arm -L /usr/arm-linux-gnueabi
            qemu_target: arm-linux-user
          - build: macos-11
            os: macos-11
            rust: nightly
    steps:
    - uses: actions/checkout@v2
      with:
        submodules: true
    - uses: ./.github/actions/install-rust
      with:
        toolchain: ${{ matrix.rust }}
    - uses: actions/checkout@v2
      with:
        repository: sunfishcode/nameless
        path: nameless
    - uses: ./.github/workflows/cross.yml
      with:
        os: ${{ matrix.os }
        target: ${{ matrix.target }}
        libc_package: ${{ matrix.libc_package }}
        gcc_package: ${{ matrix.gcc_package }}
        gcc: ${{ matrix.gcc }}
        qemu: ${{ matrix.qemu }}
        qemu_target: ${{ matrix.qemu_target }}
    - run: cd nameless && echo '[patch.crates-io]' >> Cargo.toml
    - run: cd nameless && echo 'rustix = { path = ".." }' >> Cargo.toml
    - run: cd nameless && cargo test

  cap-std-ext:
    name: cap-std-ext
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        build: [ubuntu, i686-linux, aarch64-linux, riscv64-linux, arm-linux, macos-11]
        include:
          - build: ubuntu
            os: ubuntu-latest
            rust: nightly
          - build: i686-linux
            os: ubuntu-latest
            rust: nightly
            target: i686-unknown-linux-gnu
            gcc_package: gcc-i686-linux-gnu
            gcc: i686-linux-gnu-gcc
            libc_package: libc-dev-i386-cross
          - build: aarch64-linux
            os: ubuntu-latest
            rust: nightly
            target: aarch64-unknown-linux-gnu
            gcc_package: gcc-aarch64-linux-gnu
            gcc: aarch64-linux-gnu-gcc
            qemu: qemu-aarch64 -L /usr/aarch64-linux-gnu
            qemu_target: aarch64-linux-user
          - build: riscv64-linux
            os: ubuntu-latest
            rust: nightly
            target: riscv64gc-unknown-linux-gnu
            gcc_package: gcc-riscv64-linux-gnu
            gcc: riscv64-linux-gnu-gcc
            qemu: qemu-riscv64 -L /usr/riscv64-linux-gnu
            qemu_target: riscv64-linux-user
          - build: arm-linux
            os: ubuntu-latest
            rust: nightly
            target: armv5te-unknown-linux-gnueabi
            gcc_package: gcc-arm-linux-gnueabi
            gcc: arm-linux-gnueabi-gcc
            qemu: qemu-arm -L /usr/arm-linux-gnueabi
            qemu_target: arm-linux-user
          - build: macos-11
            os: macos-11
            rust: nightly
    steps:
    - uses: actions/checkout@v2
      with:
        submodules: true
    - uses: ./.github/actions/install-rust
      with:
        toolchain: ${{ matrix.rust }}
    - uses: actions/checkout@v2
      with:
        repository: cgwalters/cap-std-ext
        path: cap-std-ext
    - uses: ./.github/workflows/cross.yml
      with:
        os: ${{ matrix.os }
        target: ${{ matrix.target }}
        libc_package: ${{ matrix.libc_package }}
        gcc_package: ${{ matrix.gcc_package }}
        gcc: ${{ matrix.gcc }}
        qemu: ${{ matrix.qemu }}
        qemu_target: ${{ matrix.qemu_target }}
    - run: cd cap-std-ext && echo '[patch.crates-io]' >> Cargo.toml
    - run: cd cap-std-ext && echo 'rustix = { path = ".." }' >> Cargo.toml
    - run: cd cap-std-ext && cargo test

  ostree-rs-ext:
    name: ostree-rs-ext
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        build: [ubuntu, i686-linux, aarch64-linux, riscv64-linux, arm-linux, macos-11]
        include:
          - build: ubuntu
            os: ubuntu-latest
            rust: nightly
          - build: i686-linux
            os: ubuntu-latest
            rust: nightly
            target: i686-unknown-linux-gnu
            gcc_package: gcc-i686-linux-gnu
            gcc: i686-linux-gnu-gcc
            libc_package: libc-dev-i386-cross
          - build: aarch64-linux
            os: ubuntu-latest
            rust: nightly
            target: aarch64-unknown-linux-gnu
            gcc_package: gcc-aarch64-linux-gnu
            gcc: aarch64-linux-gnu-gcc
            qemu: qemu-aarch64 -L /usr/aarch64-linux-gnu
            qemu_target: aarch64-linux-user
          - build: riscv64-linux
            os: ubuntu-latest
            rust: nightly
            target: riscv64gc-unknown-linux-gnu
            gcc_package: gcc-riscv64-linux-gnu
            gcc: riscv64-linux-gnu-gcc
            qemu: qemu-riscv64 -L /usr/riscv64-linux-gnu
            qemu_target: riscv64-linux-user
          - build: arm-linux
            os: ubuntu-latest
            rust: nightly
            target: armv5te-unknown-linux-gnueabi
            gcc_package: gcc-arm-linux-gnueabi
            gcc: arm-linux-gnueabi-gcc
            qemu: qemu-arm -L /usr/arm-linux-gnueabi
            qemu_target: arm-linux-user
          - build: macos-11
            os: macos-11
            rust: nightly
    steps:
    - uses: actions/checkout@v2
      with:
        submodules: true
    - uses: ./.github/actions/install-rust
      with:
        toolchain: ${{ matrix.rust }}
    - uses: actions/checkout@v2
      with:
        repository: ostreedev/ostree-rs-ext
        path: ostree-rs-ext
    - uses: ./.github/workflows/cross.yml
      with:
        os: ${{ matrix.os }
        target: ${{ matrix.target }}
        libc_package: ${{ matrix.libc_package }}
        gcc_package: ${{ matrix.gcc_package }}
        gcc: ${{ matrix.gcc }}
        qemu: ${{ matrix.qemu }}
        qemu_target: ${{ matrix.qemu_target }}
    - run: sudo apt-get update
    - run: sudo apt-get install -y libostree-dev
    - run: cd ostree-rs-ext && echo '[patch.crates-io]' >> Cargo.toml
    - run: cd ostree-rs-ext && echo 'rustix = { path = ".." }' >> Cargo.toml
    - run: cd ostree-rs-ext && cargo test

  dbus-rs:
    name: dbus-rs ported to rustix
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        build: [ubuntu, i686-linux, aarch64-linux, riscv64-linux, arm-linux, macos-11]
        include:
          - build: ubuntu
            os: ubuntu-latest
            rust: nightly
          - build: i686-linux
            os: ubuntu-latest
            rust: nightly
            target: i686-unknown-linux-gnu
            gcc_package: gcc-i686-linux-gnu
            gcc: i686-linux-gnu-gcc
            libc_package: libc-dev-i386-cross
          - build: aarch64-linux
            os: ubuntu-latest
            rust: nightly
            target: aarch64-unknown-linux-gnu
            gcc_package: gcc-aarch64-linux-gnu
            gcc: aarch64-linux-gnu-gcc
            qemu: qemu-aarch64 -L /usr/aarch64-linux-gnu
            qemu_target: aarch64-linux-user
          - build: riscv64-linux
            os: ubuntu-latest
            rust: nightly
            target: riscv64gc-unknown-linux-gnu
            gcc_package: gcc-riscv64-linux-gnu
            gcc: riscv64-linux-gnu-gcc
            qemu: qemu-riscv64 -L /usr/riscv64-linux-gnu
            qemu_target: riscv64-linux-user
          - build: arm-linux
            os: ubuntu-latest
            rust: nightly
            target: armv5te-unknown-linux-gnueabi
            gcc_package: gcc-arm-linux-gnueabi
            gcc: arm-linux-gnueabi-gcc
            qemu: qemu-arm -L /usr/arm-linux-gnueabi
            qemu_target: arm-linux-user
          - build: macos-11
            os: macos-11
            rust: nightly
  steps:
    - uses: actions/checkout@v2
      with:
        submodules: true
    - uses: ./.github/actions/install-rust
      with:
        toolchain: ${{ matrix.rust }}
    - uses: actions/checkout@v2
      with:
        repository: sunfishcode/dbus-rs
        path: dbus-rs
    - uses: ./.github/workflows/cross.yml
      with:
        os: ${{ matrix.os }
        target: ${{ matrix.target }}
        libc_package: ${{ matrix.libc_package }}
        gcc_package: ${{ matrix.gcc_package }}
        gcc: ${{ matrix.gcc }}
        qemu: ${{ matrix.qemu }}
        qemu_target: ${{ matrix.qemu_target }}
    - run: sudo apt-get update
    - run: sudo apt-get install -y libdbus-1-dev at-spi2-core
    - run: cd dbus-rs && echo '[patch.crates-io]' >> Cargo.toml
    - run: cd dbus-rs && echo 'rustix = { path = ".." }' >> Cargo.toml
    - run: cd dbus-rs && env DBUS_SESSION_BUS_ADDRESS=`dbus-daemon --session --print-address --fork` cargo test --workspace

  mustang:
    name: mustang
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        build: [ubuntu, i686-linux, aarch64-linux, riscv64-linux, arm-linux, macos-11]
        include:
          - build: ubuntu
            os: ubuntu-latest
            rust: nightly
          - build: i686-linux
            os: ubuntu-latest
            rust: nightly
            target: i686-unknown-linux-gnu
            gcc_package: gcc-i686-linux-gnu
            gcc: i686-linux-gnu-gcc
            libc_package: libc-dev-i386-cross
          - build: aarch64-linux
            os: ubuntu-latest
            rust: nightly
            target: aarch64-unknown-linux-gnu
            gcc_package: gcc-aarch64-linux-gnu
            gcc: aarch64-linux-gnu-gcc
            qemu: qemu-aarch64 -L /usr/aarch64-linux-gnu
            qemu_target: aarch64-linux-user
          - build: riscv64-linux
            os: ubuntu-latest
            rust: nightly
            target: riscv64gc-unknown-linux-gnu
            gcc_package: gcc-riscv64-linux-gnu
            gcc: riscv64-linux-gnu-gcc
            qemu: qemu-riscv64 -L /usr/riscv64-linux-gnu
            qemu_target: riscv64-linux-user
          - build: arm-linux
            os: ubuntu-latest
            rust: nightly
            target: armv5te-unknown-linux-gnueabi
            gcc_package: gcc-arm-linux-gnueabi
            gcc: arm-linux-gnueabi-gcc
            qemu: qemu-arm -L /usr/arm-linux-gnueabi
            qemu_target: arm-linux-user
          - build: macos-11
            os: macos-11
            rust: nightly
  steps:
    - uses: actions/checkout@v2
      with:
        submodules: true
    - uses: ./.github/actions/install-rust
      with:
        toolchain: ${{ matrix.rust }}
    - uses: actions/checkout@v2
      with:
        repository: sunfishcode/mustang
        path: mustang
    - uses: ./.github/workflows/cross.yml
      with:
        os: ${{ matrix.os }
        target: ${{ matrix.target }}
        libc_package: ${{ matrix.libc_package }}
        gcc_package: ${{ matrix.gcc_package }}
        gcc: ${{ matrix.gcc }}
        qemu: ${{ matrix.qemu }}
        qemu_target: ${{ matrix.qemu_target }}
    - run: rustup component add rust-src --toolchain nightly-x86_64-unknown-linux-gnu
    - run: cd mustang && echo '[patch.crates-io]' >> Cargo.toml
    - run: cd mustang && echo 'rustix = { path = ".." }' >> Cargo.toml
    # This test takes too long.
    - run: cd mustang && sed -i 's/fn concurrent_recursive_mkdir()/#[ignore]\rfn concurrent_recursive_mkdir()/' tests/fs.rs
    # Use jobs=1 to hopefully avoid apparently oversubscribing the runner.
    - run: cd mustang && cargo test --target=specs/x86_64-mustang-linux-gnu.json -Zbuild-std --jobs=1

  std:
    name: std ported to rustix
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        build: [ubuntu]
        include:
          - build: ubuntu
            os: ubuntu-latest
            rust: nightly
    steps:
    - uses: actions/checkout@v2
      with:
        submodules: true
    - uses: ./.github/actions/install-rust
      with:
        toolchain: ${{ matrix.rust }}
    - uses: actions/checkout@v2
      with:
        repository: sunfishcode/rust
        path: rust
        ref: rustix
        # Fetch enough to let the bootstrap script find an LLVM revision.
        fetch-depth: 2000
    # Include the changes needed to support std.
    - run: git fetch --depth=1 origin rustc-dep-of-std
    - run: git rebase rustc-dep-of-std
    # Download a pre-built LLVM instead of building it from source.
    - run: cd rust && echo "[llvm]" >> config.toml
    - run: cd rust && echo "download-ci-llvm = true" >> config.toml
    - run: cd rust && sed -i 's/\<git = "https:\/\/github\.com\/bytecodealliance\/rustix", branch = "rustc-dep-of-std"/path = "..\/..\/.."/' library/std/Cargo.toml
    - run: cd rust && ./x.py test library/std --stage=0
      # See <https://github.com/bytecodealliance/rustix/issues/76#issuecomment-962196433>
      env:
        RUSTFLAGS: --cfg=linux_raw --cfg=asm --cfg=rustc_attrs
